import WeakMap from '../../shim/WeakMap';
import IntersectionObserver from '../../shim/IntersectionObserver';
import { create, node, invalidator, destroy } from '../vdom';
import icache from './icache';
const defaultIntersection = Object.freeze({
    intersectionRatio: 0,
    isIntersecting: false
});
const factory = create({ icache, node, invalidator, destroy });
export const intersection = factory(({ middleware: { icache, node, invalidator, destroy } }) => {
    const handles = [];
    destroy(() => {
        let handle;
        while ((handle = handles.pop())) {
            handle && handle();
        }
    });
    function _createDetails(options, rootNode) {
        const entries = new WeakMap();
        const observer = new IntersectionObserver(_onIntersect(entries), Object.assign({}, options, { root: rootNode }));
        const details = Object.assign({ observer, entries }, options);
        icache.set(JSON.stringify(options), details, false);
        handles.push(() => observer.disconnect());
        return details;
    }
    function _getDetails(options = {}) {
        return icache.get(JSON.stringify(options));
    }
    function _onIntersect(detailEntries) {
        return (entries) => {
            for (const { intersectionRatio, isIntersecting, target } of entries) {
                detailEntries.set(target, { intersectionRatio, isIntersecting });
            }
            invalidator();
        };
    }
    return {
        get(key, options = {}) {
            let rootNode;
            if (options.root) {
                rootNode = node.get(options.root);
                if (!rootNode) {
                    return defaultIntersection;
                }
            }
            const domNode = node.get(key);
            if (!domNode) {
                return defaultIntersection;
            }
            let details = _getDetails(options) || _createDetails(options, rootNode);
            if (!details.entries.get(domNode)) {
                details.entries.set(domNode, defaultIntersection);
                details.observer.observe(domNode);
            }
            return details.entries.get(domNode) || defaultIntersection;
        }
    };
});
export default intersection;
//# sourceMappingURL=intersection.mjs.map