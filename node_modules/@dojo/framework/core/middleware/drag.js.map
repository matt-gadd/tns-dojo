{"version":3,"file":"drag.js","sourceRoot":"","sources":["drag.ts"],"names":[],"mappings":"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","sourcesContent":["import global from '../../shim/global';\nimport { assign } from '../../shim/object';\nimport { create, destroy, invalidator, node } from '../vdom';\nimport icache from './icache';\n\n/**\n * Results from a drag operation\n */\nexport interface DragResults {\n\t/**\n\t * The movement of pointer during the duration of the drag state\n\t */\n\tdelta: Position;\n\n\t/**\n\t * Is the DOM node currently in a drag state\n\t */\n\tisDragging: boolean;\n\n\t/**\n\t * A matrix of posistions that represent the start position for the current drag interaction\n\t */\n\tstart?: PositionMatrix;\n}\n\n/**\n * An x/y position structure\n */\nexport interface Position {\n\t/** Horizontal coordinate */\n\tx: number;\n\n\t/** Vertical coordinate */\n\ty: number;\n}\n\n/**\n * A matrix of x/y positions\n */\nexport interface PositionMatrix {\n\t/**\n\t * Client x/y position\n\t */\n\tclient: Position;\n\n\t/**\n\t * Offset x/y position\n\t */\n\toffset: Position;\n\n\t/**\n\t * Page x/y position\n\t */\n\tpage: Position;\n\n\t/**\n\t * Screen x/y position\n\t */\n\tscreen: Position;\n}\n\ninterface NodeData {\n\tdragResults: DragResults;\n\tlast: PositionMatrix;\n\tstart: PositionMatrix;\n}\n\nfunction getDelta(start: PositionMatrix, current: PositionMatrix): Position {\n\treturn {\n\t\tx: current.client.x - start.client.x,\n\t\ty: current.client.y - start.client.y\n\t};\n}\n\nfunction createNodeData(): NodeData {\n\treturn {\n\t\tdragResults: { ...emptyResults },\n\t\tlast: createPositionMatrix(),\n\t\tstart: createPositionMatrix()\n\t};\n}\n\nfunction createPosition(): Position {\n\treturn { x: 0, y: 0 };\n}\n\nfunction createPositionMatrix(): PositionMatrix {\n\treturn {\n\t\tclient: { x: 0, y: 0 },\n\t\toffset: { x: 0, y: 0 },\n\t\tpage: { x: 0, y: 0 },\n\t\tscreen: { x: 0, y: 0 }\n\t};\n}\n\nfunction getPositionMatrix(event: PointerEvent): PositionMatrix {\n\treturn {\n\t\tclient: {\n\t\t\tx: event.clientX,\n\t\t\ty: event.clientY\n\t\t},\n\t\toffset: {\n\t\t\tx: event.offsetX,\n\t\t\ty: event.offsetY\n\t\t},\n\t\tpage: {\n\t\t\tx: event.pageX,\n\t\t\ty: event.pageY\n\t\t},\n\t\tscreen: {\n\t\t\tx: event.screenX,\n\t\t\ty: event.screenY\n\t\t}\n\t};\n}\n\nfunction initNode(node: HTMLElement): void {\n\tnode.style.touchAction = 'none';\n\tnode.setAttribute('touch-action', 'none');\n}\n\nconst emptyResults = Object.freeze({\n\tdelta: Object.freeze(createPosition()),\n\tisDragging: false\n});\n\nconst factory = create({ destroy, icache, invalidator, node });\n\nexport const drag = factory(({ middleware: { destroy, icache, invalidator, node } }) => {\n\tlet nodeMap = new WeakMap<HTMLElement, NodeData>();\n\n\tfunction getData(target: HTMLElement): { state: NodeData; target: HTMLElement } | undefined {\n\t\tconst state = nodeMap.get(target);\n\t\tif (state) {\n\t\t\treturn { state, target };\n\t\t}\n\t}\n\n\tfunction onDragStart(event: PointerEvent) {\n\t\tconst dragging = icache.get<HTMLElement>('dragging');\n\t\tif (!event.isPrimary && dragging) {\n\t\t\tconst state = nodeMap.get(dragging)!;\n\t\t\tstate.dragResults.isDragging = false;\n\t\t\ticache.set('dragging', undefined);\n\t\t\treturn;\n\t\t}\n\t\tif (event.button !== 0) {\n\t\t\treturn;\n\t\t}\n\t\tconst data = getData(event.target as HTMLElement);\n\t\tif (data) {\n\t\t\tconst { state, target } = data;\n\t\t\ticache.set('dragging', target);\n\t\t\tstate.last = state.start = getPositionMatrix(event);\n\t\t\tstate.dragResults.delta = createPosition();\n\t\t\tstate.dragResults.start = { ...state.start };\n\t\t\tstate.dragResults.isDragging = true;\n\t\t\tinvalidator();\n\n\t\t\tevent.preventDefault();\n\t\t\tevent.stopPropagation();\n\t\t}\n\t}\n\n\tfunction onDrag(event: PointerEvent) {\n\t\tconst dragging = icache.get<HTMLElement>('dragging');\n\t\tif (!dragging) {\n\t\t\treturn;\n\t\t}\n\t\t// state cannot be unset, using ! operator\n\t\tconst state = nodeMap.get(dragging)!;\n\t\tstate.last = getPositionMatrix(event);\n\t\tstate.dragResults.delta = getDelta(state.start, state.last);\n\t\tinvalidator();\n\n\t\tevent.preventDefault();\n\t\tevent.stopPropagation();\n\t}\n\n\tfunction onDragStop(event: PointerEvent) {\n\t\tconst dragging = icache.get<HTMLElement>('dragging');\n\t\tif (!dragging) {\n\t\t\treturn;\n\t\t}\n\t\t// state cannot be unset, using ! operator\n\t\tconst state = nodeMap.get(dragging)!;\n\t\tstate.last = getPositionMatrix(event);\n\t\tstate.dragResults.delta = getDelta(state.start, state.last);\n\t\tstate.dragResults.isDragging = false;\n\t\ticache.set('dragging', undefined);\n\n\t\tevent.preventDefault();\n\t\tevent.stopPropagation();\n\t}\n\n\tconst win: Window = global;\n\twin.addEventListener('pointerdown', onDragStart);\n\twin.addEventListener('pointermove', onDrag, true);\n\twin.addEventListener('pointerup', onDragStop, true);\n\n\tdestroy(() => {\n\t\tconst win: Window = global;\n\t\twin.removeEventListener('pointerdown', onDragStart);\n\t\twin.removeEventListener('pointermove', onDrag, true);\n\t\twin.removeEventListener('pointerup', onDragStop, true);\n\t\tnodeMap = new WeakMap();\n\t});\n\n\treturn {\n\t\tget(key: string | number): Readonly<DragResults> {\n\t\t\tconst domNode = node.get(key);\n\n\t\t\tif (!domNode) {\n\t\t\t\treturn emptyResults;\n\t\t\t}\n\n\t\t\tif (!nodeMap.has(domNode)) {\n\t\t\t\tnodeMap.set(domNode, createNodeData());\n\t\t\t\tinitNode(domNode);\n\t\t\t\treturn emptyResults;\n\t\t\t}\n\n\t\t\tconst state = nodeMap.get(domNode)!;\n\t\t\tconst dragResults = assign({}, state.dragResults);\n\t\t\tstate.start = state.last;\n\t\t\tstate.dragResults.delta = createPosition();\n\t\t\tdelete state.dragResults.start;\n\n\t\t\treturn dragResults;\n\t\t}\n\t};\n});\n\nexport default drag;\n"]}