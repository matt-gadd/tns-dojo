{"version":3,"file":"i18n.js","sourceRoot":"","sources":["i18n.ts"],"names":[],"mappings":"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","sourcesContent":["import global from '../shim/global';\nimport WeakMap from '../shim/WeakMap';\nimport * as Globalize from 'globalize/dist/globalize/message';\nconst Cldr = require('cldrjs/dist/cldr');\n`!has('cldr-elide')`;\nimport './util/cldr';\n\nexport interface Messages {\n\t[key: string]: string;\n}\n\nexport interface MessageLoader {\n\t(): Promise<{ default: Messages }>;\n}\n\nexport interface CldrLoader {\n\t(): Promise<{ default: any }[]>;\n}\n\nexport interface LocaleLoaders {\n\t[index: string]: Messages | MessageLoader;\n}\n\nexport interface CldrLoaders {\n\t[index: string]: CldrLoader | true;\n}\n\nexport interface Bundle<T extends Messages> {\n\treadonly locales?: LocaleLoaders;\n\treadonly messages: T;\n}\n\nexport interface LocalizeOptions {\n\tlocale?: string;\n\tuseDefault?: boolean;\n\tinvalidator: any;\n}\n\nexport interface LocalizeResult<T extends Bundle<any>> {\n\tmessages: T['messages'];\n\tisPlaceholder: boolean;\n\tformat: (key: keyof T['messages'], options: any) => string;\n}\n\ninterface SetLocaleOptions {\n\tlocale?: string;\n\tdefault?: boolean;\n\tlocal?: boolean;\n\tinvalidator?: () => void;\n}\n\n/**\n * Ensure that the raw bundle is not mutated when\n * the resolved bundles are set\n */\nlet cldrResolved = Cldr._resolved;\n\nObject.defineProperty(Cldr, '_resolved', {\n\tget() {\n\t\treturn { ...cldrResolved };\n\t},\n\tset(value: any) {\n\t\tcldrResolved = { ...value };\n\t}\n});\n\nconst TOKEN_PATTERN = /\\{([a-z0-9_]+)\\}/gi;\nconst bundleIdMap = new WeakMap<Bundle<Messages>, string>();\nconst bundleLoaderMap = new WeakMap<MessageLoader, string>();\nconst idToBundleLoaderMap = new Map<string, MessageLoader>();\nconst globalizeInstanceMap = new Map<string, Globalize>();\nconst MESSAGE_BUNDLE_PATH = 'globalize-messages/{bundle}';\nconst DOJO_PATH = 'dojo/{bundle}/lookup';\n\nlet supportedLocales: string[] = [];\nlet defaultLocale = '';\n// Set to `unknown` to support using default message bundles\n// without an application locale configured\nlet computedLocale = 'unknown';\nlet currentLocale: string | undefined;\nlet cldrLoaders: CldrLoaders = {};\nlet bundleId = 0;\nconst cldr = new Cldr('');\n\n/**\n * Sets the array of supported locales for the application\n */\nexport function setSupportedLocales(locales: string[]) {\n\tsupportedLocales = locales;\n}\n\n/**\n * Sets the default locale of the application.\n */\nexport function setDefaultLocale(locale: string) {\n\tdefaultLocale = locale;\n}\n\n/**\n * Returns the users locale computed by using the system locale\n * of the environment and the default locale.\n *\n * The users system locale if supported by the application (i.e resolves\n * to one of the set supported locales) otherwise the registered default\n * locale.\n */\nexport function getComputedLocale() {\n\treturn computedLocale;\n}\n\n/**\n * Returns the application's current locale\n */\nexport function getCurrentLocale() {\n\treturn currentLocale;\n}\n\n/**\n * Sets the available cldr loaders for the i18n module\n */\nexport function setCldrLoaders(loaders: CldrLoaders) {\n\tcldrLoaders = { ...loaders };\n}\n\n/**\n * Returns the matching supported locale for the passed locale. If there\n * is no matching locale then undefined is returned\n */\nexport function getMatchedSupportedLocale(locale: string): string | undefined {\n\tlet partialLocale = locale.replace(/^([a-z]{2}).*/i, '$1');\n\tlet matchedLocale;\n\tfor (let i = 0; i < supportedLocales.length; i++) {\n\t\tconst supportedLocale = supportedLocales[i];\n\t\tif (locale === supportedLocale) {\n\t\t\tmatchedLocale = locale;\n\t\t\tbreak;\n\t\t}\n\t\tif (partialLocale === supportedLocale) {\n\t\t\tmatchedLocale = partialLocale;\n\t\t}\n\t}\n\treturn matchedLocale;\n}\n\n/**\n * Determines if the fallback CLDR data needs to be loaded\n * for the locale\n */\nfunction shouldLoadFallbackCldr(locale: string) {\n\treturn !getMatchedSupportedLocale(locale) && cldrLoaders.fallback && cldrLoaders.fallback !== true;\n}\n\n/**\n * Sets the i18n modules locale state based on whether the locale\n * is the default or local\n */\nfunction setI18nLocales(locale: string, isDefault: boolean, local: boolean): void {\n\tif (isDefault) {\n\t\tGlobalize.locale(locale);\n\t\tcomputedLocale = locale;\n\t\tcurrentLocale = locale;\n\t} else if (!local) {\n\t\tcurrentLocale = locale;\n\t}\n}\n\n/**\n * Load required CLDR data based on the registered loaders and support\n * for the requested locale\n */\nasync function loadCldrData(\n\tloaderPromises: Promise<any>[],\n\tuserLocale: string,\n\trequestedLocale: string,\n\tcalculatedLocale: string,\n\tisDefault: boolean,\n\tisLocal: boolean,\n\tinvalidator?: () => void\n): Promise<any> {\n\treturn Promise.all(loaderPromises).then((loaderData) => {\n\t\tcldrLoaders[userLocale] = true;\n\t\tcldrLoaders.supplemental = true;\n\t\tloaderData.forEach((results) => {\n\t\t\tresults.forEach((result: any) => {\n\t\t\t\tGlobalize.load(result.default);\n\t\t\t});\n\t\t});\n\t\tif (shouldLoadFallbackCldr(requestedLocale)) {\n\t\t\tcldrLoaders.fallback = true;\n\t\t\tconst data = cldr.get('dojo') || {};\n\t\t\tconst locales = Object.keys(data);\n\t\t\tfor (let i = 0; i < locales.length; i++) {\n\t\t\t\tconst locale = locales[i];\n\t\t\t\tif (data[locale].bundles) {\n\t\t\t\t\tGlobalize.loadMessages({ [locale]: data[locale].bundles });\n\t\t\t\t}\n\t\t\t}\n\t\t\tif (requestedLocale && locales.indexOf(requestedLocale) === -1) {\n\t\t\t\tGlobalize.loadMessages({ [requestedLocale]: {} });\n\t\t\t}\n\t\t}\n\t\tsetI18nLocales(calculatedLocale, isDefault, isLocal);\n\t\tinvalidator && invalidator();\n\t\treturn calculatedLocale;\n\t});\n}\n\n/**\n * Sets the i18n locale information for the application, loading any CLDR data or NLS\n * messages required to support the change.\n */\nexport function setLocale(options: SetLocaleOptions = {}): Promise<string> | string {\n\tconst {\n\t\tlocal: isLocal = false,\n\t\tdefault: isDefault = false,\n\t\tlocale: requestedLocale = global.navigator.language || global.navigator.userLanguage,\n\t\tinvalidator\n\t} = options;\n\tconst matchedLocale = getMatchedSupportedLocale(requestedLocale);\n\tconst userLocale = matchedLocale || defaultLocale;\n\tconst calculatedLocale = matchedLocale ? requestedLocale : defaultLocale;\n\n\tconst loaderPromises: Promise<any>[] = [];\n\tconst supplementalLoader = cldrLoaders.supplemental;\n\tconst fallbackLoader = cldrLoaders.fallback;\n\n\tif (supplementalLoader && supplementalLoader !== true) {\n\t\tloaderPromises.push(supplementalLoader());\n\t}\n\tconst localeCldrLoader = cldrLoaders[userLocale];\n\tif (localeCldrLoader && localeCldrLoader !== true) {\n\t\tloaderPromises.push(localeCldrLoader());\n\t}\n\tconst loadFallback = !matchedLocale && fallbackLoader && fallbackLoader !== true;\n\tif (loadFallback && fallbackLoader && fallbackLoader !== true) {\n\t\tloaderPromises.push(fallbackLoader());\n\t}\n\n\tif (loaderPromises.length) {\n\t\treturn loadCldrData(\n\t\t\tloaderPromises,\n\t\t\tuserLocale,\n\t\t\trequestedLocale,\n\t\t\tcalculatedLocale,\n\t\t\tisDefault,\n\t\t\tisLocal,\n\t\t\tinvalidator\n\t\t);\n\t} else if (!matchedLocale) {\n\t\tGlobalize.loadMessages({ [requestedLocale]: {} });\n\t}\n\n\tsetI18nLocales(calculatedLocale, isDefault, isLocal);\n\treturn calculatedLocale;\n}\n\nfunction getPlaceholderBundle<T extends Messages>(bundle: Bundle<T>) {\n\treturn {\n\t\tmessages: Object.keys(bundle.messages).reduce(\n\t\t\t(messages, key) => {\n\t\t\t\tmessages[key] = '';\n\t\t\t\treturn messages;\n\t\t\t},\n\t\t\t{} as any\n\t\t),\n\t\tisPlaceholder: true,\n\t\tformat: () => ''\n\t};\n}\n\nfunction getBundleId() {\n\treturn `id-${++bundleId}`;\n}\n\nfunction markBundleAsLoaded(locale: string, bundleId: string) {\n\tCldr.load({\n\t\tdojo: {\n\t\t\t[locale]: {\n\t\t\t\tlookup: {\n\t\t\t\t\t[bundleId]: {\n\t\t\t\t\t\tlocale: undefined,\n\t\t\t\t\t\tid: undefined,\n\t\t\t\t\t\tloading: undefined\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t});\n}\n\n/**\n * Registers all locale loaders for the bundle\n */\nfunction registerBundle<T extends Messages>(bundle: Bundle<T>): string {\n\tconst { locales: localeBundleLoaders = {} } = bundle;\n\tconst locales = Object.keys(localeBundleLoaders);\n\tlet bundleId = bundleIdMap.get(bundle);\n\tif (!bundleId) {\n\t\tbundleId = getBundleId();\n\t\tbundleIdMap.set(bundle, bundleId);\n\t\tconst messageBundles: { [index: string]: any } = {};\n\t\tconst lookup: { [index: string]: any } = {};\n\n\t\tfor (let i = 0; i < locales.length; i++) {\n\t\t\tconst locale = locales[i];\n\t\t\tconst isSupportedLocale = !!getMatchedSupportedLocale(locale);\n\t\t\tconst bundleLoader = localeBundleLoaders[locale];\n\t\t\tlet messages = {};\n\t\t\tif (typeof bundleLoader === 'function') {\n\t\t\t\tconst id = getBundleId();\n\t\t\t\tbundleLoaderMap.set(bundleLoader, id);\n\t\t\t\tidToBundleLoaderMap.set(id, bundleLoader);\n\t\t\t\tlookup[locale] = { lookup: { [bundleId]: { locale, id } } };\n\t\t\t} else {\n\t\t\t\tmessages = bundleLoader;\n\t\t\t}\n\t\t\tif (isSupportedLocale) {\n\t\t\t\tmessageBundles[locale] = {\n\t\t\t\t\t[bundleId]: messages\n\t\t\t\t};\n\t\t\t} else if (lookup[locale]) {\n\t\t\t\tlookup[locale].bundles = { [bundleId]: messages };\n\t\t\t} else {\n\t\t\t\tlookup[locale] = {\n\t\t\t\t\tbundles: { [bundleId]: messages }\n\t\t\t\t};\n\t\t\t}\n\t\t}\n\t\tGlobalize.loadMessages({\n\t\t\troot: { [bundleId]: bundle.messages },\n\t\t\t[computedLocale]: { [bundleId]: bundle.messages },\n\t\t\t[defaultLocale]: { [bundleId]: bundle.messages },\n\t\t\t...messageBundles\n\t\t});\n\t\tCldr.load({ dojo: lookup });\n\t}\n\treturn bundleId;\n}\n\nconst cachedBundleMap = new WeakMap<Bundle<any>, Map<string, LocalizeResult<Bundle<any>>>>();\n\nexport function localizeBundle<T extends Messages>(\n\tbundle: Bundle<T>,\n\toptions: LocalizeOptions\n): LocalizeResult<Bundle<T>> {\n\tlet { locale = computedLocale, invalidator } = options;\n\tif (computedLocale === 'unknown') {\n\t\treturn {\n\t\t\tmessages: bundle.messages,\n\t\t\tisPlaceholder: false,\n\t\t\tformat: (key, options) => {\n\t\t\t\treturn bundle.messages[key].replace(TOKEN_PATTERN, (token, property) => {\n\t\t\t\t\tconst value = options[property];\n\t\t\t\t\tif (typeof value === 'undefined') {\n\t\t\t\t\t\treturn token;\n\t\t\t\t\t}\n\t\t\t\t\treturn value;\n\t\t\t\t});\n\t\t\t}\n\t\t};\n\t}\n\tif (shouldLoadFallbackCldr(locale)) {\n\t\tsetLocale({ default: false, local: true, locale, invalidator });\n\t\treturn getPlaceholderBundle(bundle);\n\t}\n\tconst bundleId = registerBundle(bundle);\n\tconst globalize = globalizeInstanceMap.get(locale) || new Globalize(new Cldr(locale));\n\tglobalizeInstanceMap.set(locale, globalize);\n\tconst lookupId = globalize.cldr.get(`${DOJO_PATH}/${bundleId}/id`);\n\tconst lookupLocale = globalize.cldr.get(`${DOJO_PATH}/${bundleId}/locale`);\n\tif (lookupId && lookupLocale) {\n\t\tlet bundleLoader = idToBundleLoaderMap.get(lookupId);\n\t\tif (bundleLoader) {\n\t\t\tCldr.load({\n\t\t\t\tdojo: {\n\t\t\t\t\t[lookupLocale]: { lookup: { [bundleId]: { loading: true } } }\n\t\t\t\t}\n\t\t\t});\n\t\t\tconst loaderPromise = bundleLoader();\n\t\t\tloaderPromise.then((messages) => {\n\t\t\t\tmarkBundleAsLoaded(lookupLocale, bundleId as string);\n\t\t\t\tGlobalize.loadMessages({ [lookupLocale]: { [bundleId as string]: messages.default } });\n\t\t\t\tinvalidator();\n\t\t\t});\n\t\t}\n\t}\n\tconst lookupLoading = globalize.cldr.get(`${DOJO_PATH}/${bundleId}/loading`);\n\n\tif (lookupLoading) {\n\t\treturn getPlaceholderBundle(bundle);\n\t}\n\n\tconst cachedLocaleMessagesMap = cachedBundleMap.get(bundle) || new Map<string, LocalizeResult<Bundle<any>>>();\n\tlet localizedBundleMessages = cachedLocaleMessagesMap.get(locale);\n\tif (!localizedBundleMessages) {\n\t\tlocalizedBundleMessages = {\n\t\t\tmessages: Object.keys(bundle.messages).reduce(\n\t\t\t\t(messages, key) => {\n\t\t\t\t\tconst message = globalize.cldr.get(`${MESSAGE_BUNDLE_PATH}/${bundleId}/${key}`);\n\t\t\t\t\tmessages[key] = message;\n\t\t\t\t\treturn messages;\n\t\t\t\t},\n\t\t\t\t{} as any\n\t\t\t),\n\t\t\tisPlaceholder: false,\n\t\t\tformat: (key: any, options: {}) => {\n\t\t\t\treturn globalize.formatMessage(`${bundleId}/${key}`, options);\n\t\t\t}\n\t\t};\n\t\tcachedLocaleMessagesMap.set(locale, localizedBundleMessages);\n\t\tcachedBundleMap.set(bundle, cachedLocaleMessagesMap);\n\t}\n\treturn localizedBundleMessages;\n}\n"]}