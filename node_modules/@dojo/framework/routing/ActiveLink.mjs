var __rest = (this && this.__rest) || function (s, e) {
    var t = {};
    for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p) && e.indexOf(p) < 0)
        t[p] = s[p];
    if (s != null && typeof Object.getOwnPropertySymbols === "function")
        for (var i = 0, p = Object.getOwnPropertySymbols(s); i < p.length; i++) if (e.indexOf(p[i]) < 0)
            t[p[i]] = s[p[i]];
    return t;
};
import { create, diffProperty, invalidator, w } from '../core/vdom';
import injector from '../core/middleware/injector';
import icache from '../core/middleware/icache';
import Link from './Link';
function paramsEqual(linkParams = {}, contextParams = {}) {
    return Object.keys(linkParams).every((key) => linkParams[key] === contextParams[key]);
}
const factory = create({ injector, diffProperty, icache, invalidator }).properties();
export const ActiveLink = factory(function ActiveLink({ middleware: { diffProperty, injector, icache, invalidator }, properties, children }) {
    const { to, routerKey = 'router', params } = properties();
    let _a = properties(), { activeClasses, isExact, classes = [] } = _a, props = __rest(_a, ["activeClasses", "isExact", "classes"]);
    diffProperty('to', (current, next) => {
        if (current.to !== next.to) {
            const router = injector.get(routerKey);
            const currentHandle = icache.get('handle');
            if (currentHandle) {
                currentHandle.destroy();
            }
            if (router) {
                const handle = router.on('route', ({ route }) => {
                    if (route.id === to) {
                        invalidator();
                    }
                });
                icache.set('handle', () => handle);
            }
            invalidator();
        }
    });
    const router = injector.get(routerKey);
    if (router) {
        if (!icache.get('handle')) {
            const handle = router.on('route', ({ route }) => {
                if (route.id === to) {
                    invalidator();
                }
            });
            icache.set('handle', () => handle);
        }
        const context = router.getRoute(to);
        const isActive = context && paramsEqual(params, Object.assign({}, context.params, context.queryParams));
        const contextIsExact = context && context.isExact();
        classes = Array.isArray(classes) ? classes : [classes];
        if (isActive && (!isExact || contextIsExact)) {
            classes = [...classes, ...activeClasses];
        }
        props = Object.assign({}, props, { classes });
    }
    return w(Link, props, children());
});
export default ActiveLink;
//# sourceMappingURL=ActiveLink.mjs.map